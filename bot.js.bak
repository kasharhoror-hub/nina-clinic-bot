cat > bot.js <<'JS'
/*
  bot.js - Nina Medium Clinic (CommonJS)
  - Requires: telegraf, dotenv
  - Reads: BOT_TOKEN, ADMIN_ID from .env
  - Behavior: start menu with image + service descriptions (Amharic+English),
              booking wizard, sends summary to user and ADMIN_ID, Start Again button.
*/

require('dotenv').config();
const { Telegraf, Markup } = require('telegraf');

const BOT_TOKEN = process.env.BOT_TOKEN;
const ADMIN_ID = process.env.ADMIN_ID ? parseInt(process.env.ADMIN_ID, 10) : null;

if (!BOT_TOKEN) {
  console.error('âŒ BOT_TOKEN missing in .env');
  process.exit(1);
}
if (!ADMIN_ID) {
  console.error('âŒ ADMIN_ID missing or invalid in .env');
  // we continue but admin will not receive messages; comment out exit if you want to test locally without admin
  // process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);

// In-memory sessions map: chatId -> session object
const sessions = new Map();

// Clinic image (change URL if you want)
const WELCOME_IMAGE = 'https://i.imgur.com/vu4bO4H.jpeg';

// Build the welcome caption (Amharic + English)
function welcomeText() {
  return (
`ðŸ‘‹ áŠ¥áŠ•áŠ³áŠ• á‹ˆá‹° Nina Medium Clinic á‰ á‹°áˆ…áŠ“ áˆ˜áŒ¡!
Welcome to *Nina Medium Clinic*.

ðŸ©º áŠ¥áŠ› á‹¨áˆáŠ“á‰€áˆ­á‰£á‰¸á‹ áŠ áŒˆáˆáŒáˆŽá‰¶á‰½ | Our services:
â€¢ ðŸ’‰ á‹¨áˆ…áŠ­áˆáŠ“ áˆáˆ­áˆ˜áˆ« / Check-up
  - Regular medical examination, blood pressure, tests.
â€¢ â¤ï¸ áŠ áŒ á‰ƒáˆ‹á‹­ áˆáˆ­áˆ˜áˆ« / General Diagnosis
  - Full assessment and treatment advice.

ðŸ“… áŠ¥á‰£áŠ­á‹Ž áˆˆá‰¦á‰³ áˆ›áˆµá‹«á‹£ á‰€áŒ¥áˆ‰á¢
To book an appointment press the button below.`
  );
}

// Helper: format summary for admin (Markdown)
function formatAdminSummary(session, from) {
  return (
`ðŸ“© *New Booking Received*

ðŸ‘¤ *Full Name:* ${session.fullName || 'N/A'}
ðŸ“ž *Contact:* ${session.contact || 'N/A'}
ðŸ©º *Service:* ${session.service || 'N/A'}
ðŸ“… *Preferred Date/Time:* ${session.datetime || 'N/A'}
ðŸ’¬ *Message:* ${session.message || 'N/A'}

â€¢ From Telegram: ${from.first_name || ''} ${from.last_name || ''} (@${from.username || 'N/A'})
`
  );
}

// /start - show image + caption + Start/Cancel buttons
bot.start(async (ctx) => {
  sessions.delete(ctx.chat.id);

  try {
    await ctx.replyWithPhoto(WELCOME_IMAGE, {
      caption: welcomeText(),
      parse_mode: 'Markdown',
    });
  } catch (e) {
    // fallback: if image fails, just send text
    await ctx.reply(welcomeText());
  }

  await ctx.reply(
    'Please choose an option / áŠ¥á‰£áŠ­á‹Ž áŠ áŠ•á‹±áŠ• á‹­áˆáˆ¨áŒ¡:',
    Markup.inlineKeyboard([
      [Markup.button.callback('áˆˆáˆ˜áŒ€áˆ˜áˆ­ / Start', 'start_booking')],
      [Markup.button.callback('á‰°á‹ˆá‹ / Cancel', 'cancel_booking')]
    ])
  );
});

// Cancel handler
bot.action('cancel_booking', async (ctx) => {
  sessions.delete(ctx.chat.id);
  try { await ctx.editMessageText('âŒ áˆ‚á‹°á‰± á‰°áˆ°áˆ­á‹Ÿáˆá¢ Booking cancelled.'); } catch(e) {}
  await ctx.reply('Booking canceled. Send /start to begin again.');
});

// Start booking - initialize session and ask for full name
bot.action('start_booking', async (ctx) => {
  sessions.set(ctx.chat.id, { step: 'name' });
  try { await ctx.editMessageText('ðŸ‘¤ áŠ¥á‰£áŠ­á‹Ž áˆ™áˆ‰ áˆµáˆá‹ŽáŠ• á‹«áˆµáŒˆá‰¡ / Please enter your Full Name:'); } catch(e) {}
});

// Service buttons
bot.action('service_checkup', async (ctx) => {
  const s = sessions.get(ctx.chat.id);
  if (!s) return ctx.reply('Session expired. Send /start to begin.');
  s.service = 'ðŸ’‰ á‹¨áˆ…áŠ­áˆáŠ“ áˆáˆ­áˆ˜áˆ« / Check-up';
  s.step = 'datetime';
  try { await ctx.editMessageText('ðŸ“… áŠ¥á‰£áŠ­á‹Ž á‹¨á‰€áŠ• áŠ¥áŠ“ áˆ°á‹“á‰µ á‹«áˆµáŒˆá‰¡ / Enter preferred Date & Time (e.g., 2025-10-27 14:00):'); } catch(e) {}
});

bot.action('service_diagnosis', async (ctx) => {
  const s = sessions.get(ctx.chat.id);
  if (!s) return ctx.reply('Session expired. Send /start to begin.');
  s.service = 'â¤ï¸ áŠ áŒ á‰ƒáˆ‹á‹­ áˆáˆ­áˆ˜áˆ« / General Diagnosis';
  s.step = 'datetime';
  try { await ctx.editMessageText('ðŸ“… áŠ¥á‰£áŠ­á‹Ž á‹¨á‰€áŠ• áŠ¥áŠ“ áˆ°á‹“á‰µ á‹«áˆµáŒˆá‰¡ / Enter preferred Date & Time (e.g., 2025-10-27 14:00):'); } catch(e) {}
});

// Text handler for wizard steps
bot.on('text', async (ctx) => {
  const chatId = ctx.chat.id;
  const text = (ctx.message && ctx.message.text) ? ctx.message.text.trim() : '';
  const session = sessions.get(chatId);

  if (!session) {
    return ctx.reply('Send /start to begin the booking process. / áŠ¥á‰£áŠ­á‹Ž /start á‹­áŒ«áŠ‘á¢');
  }

  try {
    switch (session.step) {
      case 'name':
        session.fullName = text;
        session.step = 'contact';
        await ctx.reply('ðŸ“ž áŠ¥á‰£áŠ­á‹Ž áˆµáˆáŠ­ á‰áŒ¥áˆ­á‹ŽáŠ• á‹ˆá‹­áˆ áŠ¢áˆœá‹­áˆá‹ŽáŠ• á‹«áˆµáŒˆá‰¡ / Please enter your Contact (phone or email):');
        break;

      case 'contact':
        session.contact = text;
        session.step = 'service';
        await ctx.reply(
          'ðŸ©º á‹¨áˆšáˆáˆáŒ‰á‰µáŠ• áŠ áŒˆáˆáŒáˆŽá‰µ á‹­áˆáˆ¨áŒ¡ / Please choose the service:',
          Markup.inlineKeyboard([
            [Markup.button.callback('ðŸ’‰ á‹¨áˆ…áŠ­áˆáŠ“ áˆáˆ­áˆ˜áˆ« / Check-up', 'service_checkup')],
            [Markup.button.callback('â¤ï¸ áŠ áŒ á‰ƒáˆ‹á‹­ áˆáˆ­áˆ˜áˆ« / General Diagnosis', 'service_diagnosis')]
          ])
        );
        break;

      case 'datetime':
        session.datetime = text;
        session.step = 'message';
        await ctx.reply('ðŸ’¬ áˆ›áŠ•áˆ³á‰µ / Any additional message or inquiry? (type "none" if none):');
        break;

      case 'message':
        session.message = text;

        // Build user summary (plain)
        const userSummary =
`ðŸ“© Thank you â€” here is your booking summary:

ðŸ‘¤ Full Name: ${session.fullName}
ðŸ“ž Contact: ${session.contact}
ðŸ©º Service: ${session.service}
ðŸ“… Preferred Date/Time: ${session.datetime}
ðŸ’¬ Message: ${session.message}

We will contact you soon.
`;

        // Build admin summary (Markdown friendly)
        const adminSummary = formatAdminSummary(session, ctx.from);

        // Send summary to user
        await ctx.reply(userSummary, Markup.inlineKeyboard([
          [Markup.button.callback('ðŸ” áŠ¥áŠ•á‹°áŒˆáŠ“ áŒ€áˆáˆ­ / Start Again', 'start_booking')]
        ]));

        // Send to admin (if ADMIN_ID set)
        if (ADMIN_ID) {
          try {
            await bot.telegram.sendMessage(ADMIN_ID, adminSummary, { parse_mode: 'Markdown' });
            console.log('âœ… Sent booking to admin', ADMIN_ID);
          } catch (err) {
            console.error('âŒ Failed to send booking to admin:', err && err.message ? err.message : err);
            await ctx.reply('âš ï¸ Warning: failed to notify admin. Please try again later.');
          }
        } else {
          console.warn('No ADMIN_ID set, admin will not receive messages.');
        }

        sessions.delete(chatId);
        break;

      default:
        await ctx.reply('Unexpected step. Send /start to begin again. / áŠ¥á‰£áŠ­á‹Ž /start á‹­áŒ«áŠ‘á¢');
    }
  } catch (err) {
    console.error('Handler error:', err && err.stack ? err.stack : err);
    sessions.delete(chatId);
    await ctx.reply('âš ï¸ An error occurred. Please send /start and try again. / áŠ¥á‰£áŠ­á‹Ž /start á‹­áŒ«áŠ‘á¢');
  }
});

// Global error logging
bot.catch((err, ctx) => {
  console.error('Bot error', err);
});

// Launch bot
bot.launch()
  .then(()=> console.log('ðŸ¤– Bot is running successfully...'))
  .catch(err => console.error('Launch error', err));

// graceful shutdown
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
JS
